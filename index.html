<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="description" content="Monitor ROS robots directly from the web. Plug in a gameped and teleoperate effortlessly. Teleop.xyz is an open source remote mangement solution for ROS devices.">
  <meta name="keywords" content="ROS, Robotics Operating System, rviz, teleop, rosrun, roslaunch, robot, robotics, robot cloud, cloud robotics, teleoperation, teleop-xyz, ros multimachine, ros machine, roscloud, roshub, robot fleet, fleet management, remote montitoring">
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1">
  <title>teleop.xyz - sense, plan, party ðŸ¤˜</title>


  <!--<script type="text/javascript" src="static/js/three.v0.134.0.js"></script>-->
  <!--<script src="https://static.robotwebtools.org/threejs/r89/ColladaLoader.js"></script>
  <script src="https://static.robotwebtools.org/threejs/r89/STLLoader.js"></script>-->
  <!--<script type="text/javascript" src="static/js/eventemitter2.min.js"></script>-->
  <script type="text/javascript" src="static/js/roslib.v1.1.0.js"></script>
  <script type="text/javascript" src="static/js/ros3d.v1.1.1.js"></script>
  <!--<script type="text/javascript" src="static/js/shim/ros3d-ColladaLoader.v1.0.1.js"></script>-->

  
  <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&family=Roboto:ital,wght@1,900&family=Zen+Tokyo+Zoo&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="static/main.css">
  <script type="text/javascript" src="dist/teleopxyz.js"></script>

<script>

var viz = null

  
function openConnectionForm(){
  var modal = document.getElementById("myModal")
  modal.style.display = "block";

  var logo = document.getElementById('logo')
  logo.classList.remove('hidden')
}

function closeConnectionForm(){
  if(viz == null){
    return
  }
  var modal = document.getElementById("myModal");
  modal.style.display = "none";
  var logo = document.getElementById('logo')
  logo.classList.add('hidden')
}

function setConnectionStatus(text, color){
  const statusText = document.getElementById('status-text')
  statusText.textContent = text+' '

  const statusDot = document.getElementById('status-dot')
  statusDot.style.color = color
  statusDot.style.backgroundColor = color
}

async function init(){
  const form = document.getElementsByName('connectionForm')[0]
  form.addEventListener('submit', startConnection);

  const versionText = document.getElementById('version-text')
  versionText.innerText = 'v'+teleopxyz.version

  // Get the modal
  var modal = document.getElementById("myModal");

  // Get the button that opens the modal
  var btn = document.getElementById("myBtn");

  // Get the <span> element that closes the modal
  var span = document.getElementsByClassName("close")[0];

  // When the user clicks on <span> (x), close the modal
  span.onclick = closeConnectionForm

  // When the user clicks anywhere outside of the modal, close it
  window.onclick = function(event) {
    if (event.target == modal) {
      closeConnectionForm()
    }
  }

  await setConnectionStatus('Offline', 'grey')
  openConnectionForm()


  await setupServiceWorker()

}




async function startConnection(e){
  event.preventDefault()
  console.log('startConnection')
  const formData = new FormData(e.target);
  const formProps = Object.fromEntries(formData);
  const reader = new FileReader()
  console.log(formProps)

  let fileLoad = new Promise((resolve, reject)=>{
    reader.onload = resolve
    reader.onabort = reject
    reader.addEventListener('error', reject)
  })
  
  reader.readAsText(formProps.rvizFile)

  await fileLoad

  console.log(reader.result)

  viz = new teleopxyz()

  try{
    await viz.start(formProps.rosapiHost, reader.result)

    const helpText = document.getElementById('help-text')
    helpText.classList.add('hidden')
  }
  catch(err){
    console.log('error', err)
    setConnectionStatus('Error:  '+formProps.rosapiHost, 'red')

    const helpText = document.getElementById('help-text')
    helpText.classList.remove('hidden')
    viz = null

    return
  }
  

  closeConnectionForm()

  setConnectionStatus('Connected to: '+formProps.rosapiHost, 'rgb(0, 255, 72)')

}

function reload(){
  window.location = ''+window.location
}

function gotoGithub(){
  window.location = 'https://github.com/datapartyjs/teleop-xyz'
}

function onServiceWorkerMessage(message){
  console.log('service-worker-message: ', message)

  if(viz){
    viz.onServiceWorkerMessage(message)
  }
}

function onServicerWorkerError(error){
  console.error('service-worker-error: ', error)
}

let serviceWorker

async function setupServiceWorker(){
  if ('serviceWorker' in navigator) {
    const registration = await navigator.serviceWorker.register('service-worker.js')

    navigator.serviceWorker.addEventListener('message', onServiceWorkerMessage)
    navigator.serviceWorker.addEventListener('error', onServicerWorkerError)

    registration.addEventListener('updatefound', ()=>{
      console.log('service-worker-registration: Update found')
    })


    if (registration.installing) {
      serviceWorker = registration.installing
      console.log('servicer-worker installing')
    } else if (registration.waiting) {
      serviceWorker = registration.waiting
      console.log('servicer-worker waiting')
    } else if (registration.active) {
      serviceWorker = registration.active
      console.log('servicer-worker active')
    }

    if (serviceWorker) {
      // logState(serviceWorker.state);
      serviceWorker.addEventListener('statechange',  (event) => {
        console.log('servicer-worker statechange ', event)
      })

    }
  } else {
      // The current browser doesn't support service workers.
      console.warn('service-worker: No service worker support')
  }
}

</script>
</head>

<body onload="init()">



  <div class="box">
    <div class='header' id='header' onclick='reload()'>teleop.xyz</div>

    <div class="status-area">
      <span id='status-text'>Status</span><span id='status-dot' class='green-dot'></span>
    </div>

    <div id="viewer" class="content"></div>

    <span id='help-text' class="tooltiptext hidden">See <a href='https://github.com/datapartyjs/teleop-xyz/blob/master/README.md#troubleshooting'>troubleshooting guide</a> for help</span>

    <!-- The Modal -->
    <div id="myModal" class="modal">

      <!-- Modal content -->
      <div class="modal-content">
        <form name="connectionForm">
        <div class="modal-header">
          <span class="close">&times;</span>
          <h2>Setup Connection</h2>
        </div>
        <div class="modal-body">
          
            <p>
              <labal for="rosapiHost">rosapi host</labal>
              <input type="url" name="rosapiHost" placeholder="ws://"/>
            </p>
        
            <p>
              <labal for="rvizFile">rviz file</labal>
              <input type="file" name="rvizFile" accept=".rviz"/>
            </p>

            <br>
  
            <p>
              <center><button class='setup-submit' type="submit">connect</button></center>
            </p>
        </div>
        <div class="modal-footer" onclick='gotoGithub()'>
          <h3>About  
            <a href='https://github.com/datapartyjs/teleop-xyz' target='_'> <img src='static/images/github.png' height="32px"></a>
          </h3>
        </div>
        </form>
      </div>

    </div>

    <div class="center-modal rainbows" id='logo' hidden=true>teleop.xyz</div>



    <footer class='footer'>
      </span> teleop.xyz - <span id='version-text'></span> Â© 2021 <a href='https://www.dataparty.xyz/'>dataparty llc</a>
    </footer>
  </div>
</body>
</html>
